# Trusting the main CELS Nginx to send the real user IP address
set_real_ip_from 140.221.28.60;
set_real_ip_from 140.221.28.61;
set_real_ip_from 140.221.28.62;
# External CELS Nginx
set_real_ip_from 140.221.25.27;
set_real_ip_from 140.221.25.3;
set_real_ip_from 140.221.25.28;
set_real_ip_from 140.221.25.29;
real_ip_header X-Forwarded-For;

# Gunicorn service
upstream gunicorn {
    server 127.0.0.1:8000;
}

# HTTPS server
server {

    # Port 443 for encrypted traffic
    listen 443 ssl default_server;
    listen [::]:443 ssl default_server;
    
    # Note: You should disable gzip for SSL traffic.
    # See: https://bugs.debian.org/773332

    # Read up on ssl_ciphers to ensure a secure configuration.
    # See: https://bugs.debian.org/765782

    # Self signed certs generated by the ssl-cert package
    # Don't use them in a production server!
    include snippets/snakeoil.conf;

    # Location of frontend files
    # root /var/www/html;
    
    # Add index.php to the list if you are using PHP
    # index index.html index.htm index.nginx-debian.html;

    server_name _;

    # Base URL of the API
    location / {
        proxy_pass http://gunicorn;
        include proxy_params;
        proxy_set_header SCRIPT_NAME /gunicorn;

        # API logs
        access_log /var/log/nginx/api.access.log;
        error_log /var/log/nginx/api.error.log info;
    }

    # Nginx logs
	access_log /var/log/nginx/access.log;
	error_log /var/log/nginx/error.log warn;

    # pass PHP scripts to FastCGI server
    #location ~ \.php$ {
    #    include snippets/fastcgi-php.conf;
    #
    #    # With php-fpm (or other unix sockets):
    #    fastcgi_pass unix:/run/php/php7.4-fpm.sock;
    #    # With php-cgi (or other tcp sockets):
    #    fastcgi_pass 127.0.0.1:9000;
    #}

    # deny access to .htaccess files, if Apache's document root
    # concurs with nginx's one
    #
    #location ~ /\.ht {
    #    deny all;
    #}
}